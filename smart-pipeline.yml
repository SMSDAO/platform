name: SMSDAO Smart Pipeline

# â”€â”€ REUSABLE WORKFLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Consumer repos call this via:
#   jobs:
#     pipeline:
#       uses: SMSDAO/platform/.github/workflows/smart-pipeline.yml@v1
#       secrets: inherit
# Nothing else is needed in consumer repos.
on:
  workflow_call:
    inputs:
      phase:
        description: "Pipeline phase"
        type: string
        default: "Full"
      env:
        description: "Target environment"
        type: string
        default: "Dev"
      dry_run:
        description: "Dry run mode"
        type: boolean
        default: false
      platform_ref:
        description: "SMSDAO/platform ref to use (default: v1)"
        type: string
        default: "v1"
    secrets:
      GH_TOKEN:
        required: false
      AWS_ROLE_ARN:
        required: false
      AZURE_CREDENTIALS:
        required: false
      KUBECONFIG_DATA:
        required: false
      VERCEL_TOKEN:
        required: false

  # Also triggerable directly for platform development
  workflow_dispatch:
    inputs:
      phase:
        description: "Pipeline phase"
        type: choice
        default: Full
        options: [Build, Test, Deploy, Full, Heal, ValidateEnv, Policy]
      env:
        description: "Target environment"
        type: choice
        default: Dev
        options: [Dev, Staging, Prod]
      dry_run:
        description: "Dry run mode"
        type: boolean
        default: false

concurrency:
  group: smsdao-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Resolve â€” compute env + phase + PR context once
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  resolve:
    name: Resolve Config
    runs-on: ubuntu-latest
    outputs:
      env:       ${{ steps.r.outputs.env }}
      phase:     ${{ steps.r.outputs.phase }}
      pr_number: ${{ steps.r.outputs.pr_number }}
      dry_run:   ${{ steps.r.outputs.dry_run }}
    steps:
      - name: Resolve
        id: r
        shell: pwsh
        run: |
          $phase = "${{ inputs.phase }}"
          if ([string]::IsNullOrEmpty($phase)) { $phase = "Full" }
          echo "phase=$phase" >> $env:GITHUB_OUTPUT

          $env_ = "${{ inputs.env }}"
          if ([string]::IsNullOrEmpty($env_)) {
              $env_ = switch ("${{ github.ref_name }}") {
                  "main"    { "Prod"    }
                  "develop" { "Staging" }
                  default   { "Dev"     }
              }
          }
          echo "env=$env_" >> $env:GITHUB_OUTPUT
          echo "pr_number=${{ github.event.pull_request.number }}" >> $env:GITHUB_OUTPUT
          echo "dry_run=${{ inputs.dry_run }}" >> $env:GITHUB_OUTPUT
          Write-Host "SMSDAO | Phase=$phase | Env=$env_"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Checkout platform â€” makes pipeline script available to all jobs
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  platform:
    name: Load Platform
    needs: resolve
    runs-on: ubuntu-latest
    steps:
      - name: Checkout consumer repo
        uses: actions/checkout@v4
        with:
          path: consumer

      - name: Checkout SMSDAO/platform
        uses: actions/checkout@v4
        with:
          repository: SMSDAO/platform
          ref: ${{ inputs.platform_ref || 'v1' }}
          path: platform
          token: ${{ secrets.GH_TOKEN || github.token }}

      - name: Cache platform + consumer workspace
        uses: actions/cache@v4
        with:
          path: |
            consumer/
            platform/
          key: smsdao-workspace-${{ github.sha }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Policy Gate â€” governance check before any destructive phase
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  policy:
    name: Governance Policy
    needs: [resolve, platform]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Restore workspace
        uses: actions/cache@v4
        with:
          path: |
            consumer/
            platform/
          key: smsdao-workspace-${{ github.sha }}

      - name: Run Policy Check
        shell: pwsh
        working-directory: consumer
        env:
          GH_TOKEN:          ${{ secrets.GH_TOKEN || github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER:         ${{ needs.resolve.outputs.pr_number }}
        run: |
          $dr = "${{ needs.resolve.outputs.dry_run }}" -eq "true"
          ../platform/bin/pipeline.ps1 -Phase Policy `
            -Env "${{ needs.resolve.outputs.env }}" `
            $(if ($dr) { "-DryRun" })

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Heal â€” runs before build on PRs to main
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  heal:
    name: Smart Heal
    needs: [resolve, platform]
    runs-on: ubuntu-latest
    if: |
      needs.resolve.outputs.phase == 'Heal' ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Restore workspace
        uses: actions/cache@v4
        with:
          path: |
            consumer/
            platform/
          key: smsdao-workspace-${{ github.sha }}

      - name: Run Heal Phase
        shell: pwsh
        working-directory: consumer
        env:
          GH_TOKEN:          ${{ secrets.GH_TOKEN || github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER:         ${{ needs.resolve.outputs.pr_number }}
        run: |
          $dr = "${{ needs.resolve.outputs.dry_run }}" -eq "true"
          ../platform/bin/pipeline.ps1 -Phase Heal `
            -Env "${{ needs.resolve.outputs.env }}" `
            $(if ($dr) { "-DryRun" })

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Build
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build
    needs: [resolve, platform, policy]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.policy.result != 'failure' &&
      (needs.resolve.outputs.phase == 'Build' ||
       needs.resolve.outputs.phase == 'Full')
    permissions:
      pull-requests: write
    steps:
      - name: Restore workspace
        uses: actions/cache@v4
        with:
          path: |
            consumer/
            platform/
          key: smsdao-workspace-${{ github.sha }}

      - name: Setup Node
        if: hashFiles('consumer/package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: consumer/package-lock.json

      - name: Setup .NET
        if: hashFiles('consumer/**/*.csproj') != ''
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Run Build Phase
        shell: pwsh
        working-directory: consumer
        env:
          GH_TOKEN:          ${{ secrets.GH_TOKEN || github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER:         ${{ needs.resolve.outputs.pr_number }}
        run: |
          $dr = "${{ needs.resolve.outputs.dry_run }}" -eq "true"
          ../platform/bin/pipeline.ps1 -Phase Build `
            -Env "${{ needs.resolve.outputs.env }}" `
            $(if ($dr) { "-DryRun" })

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: |
            consumer/publish/
            consumer/.next/
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Test
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Test
    needs: [resolve, build]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.resolve.outputs.phase == 'Test' ||
       needs.resolve.outputs.phase == 'Full')
    permissions:
      pull-requests: write
    steps:
      - name: Restore workspace
        uses: actions/cache@v4
        with:
          path: |
            consumer/
            platform/
          key: smsdao-workspace-${{ github.sha }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: consumer/

      - name: Run Test Phase
        shell: pwsh
        working-directory: consumer
        env:
          GH_TOKEN:          ${{ secrets.GH_TOKEN || github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER:         ${{ needs.resolve.outputs.pr_number }}
        run: |
          $dr = "${{ needs.resolve.outputs.dry_run }}" -eq "true"
          ../platform/bin/pipeline.ps1 -Phase Test `
            -Env "${{ needs.resolve.outputs.env }}" `
            $(if ($dr) { "-DryRun" })

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            consumer/TestResults/
            consumer/coverage/

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Deploy
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy -> ${{ needs.resolve.outputs.env }}
    needs: [resolve, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.resolve.outputs.env }}
    if: |
      always() &&
      needs.test.result == 'success' &&
      (needs.resolve.outputs.phase == 'Deploy' ||
       needs.resolve.outputs.phase == 'Full')
    permissions:
      pull-requests: write
      id-token: write
    steps:
      - name: Restore workspace
        uses: actions/cache@v4
        with:
          path: |
            consumer/
            platform/
          key: smsdao-workspace-${{ github.sha }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: consumer/

      - name: Configure AWS (if aws provider)
        if: vars.DEPLOY_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region:     ${{ vars.AWS_REGION }}

      - name: Azure login (if azure provider)
        if: vars.DEPLOY_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup kubectl (if k8s provider)
        if: vars.DEPLOY_PROVIDER == 'k8s' || vars.DEPLOY_PROVIDER == ''
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        if: vars.DEPLOY_PROVIDER == 'k8s' || vars.DEPLOY_PROVIDER == ''
        run: echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > $HOME/.kube/config

      - name: Run Deploy Phase
        shell: pwsh
        working-directory: consumer
        env:
          GH_TOKEN:          ${{ secrets.GH_TOKEN || github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER:         ${{ needs.resolve.outputs.pr_number }}
        run: |
          $provider = "${{ vars.DEPLOY_PROVIDER }}"
          if ([string]::IsNullOrEmpty($provider)) { $provider = "k8s" }
          $dr = "${{ needs.resolve.outputs.dry_run }}" -eq "true"

          # Secrets injected via Args â€” never stored in config files
          $args_ = @{
              provider    = $provider
              vercelToken = "${{ secrets.VERCEL_TOKEN }}"
          }
          ../platform/bin/pipeline.ps1 -Phase Deploy `
            -Env  "${{ needs.resolve.outputs.env }}" `
            -Args $args_ `
            $(if ($dr) { "-DryRun" })

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  PR Summary â€” aggregate final comment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-summary:
    name: PR Summary
    needs: [resolve, policy, heal, build, test, deploy]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Post aggregate summary
        uses: actions/github-script@v7
        with:
          script: |
            const botTag  = '<!-- smsdao-pipeline-bot -->';
            const env_    = '${{ needs.resolve.outputs.env }}';
            const phase   = '${{ needs.resolve.outputs.phase }}';
            const prNum   = parseInt('${{ github.event.pull_request.number }}');
            const runUrl  = `[${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            const ts      = new Date().toISOString().replace('T',' ').substring(0,19) + ' UTC';

            const results = {
              Policy: '${{ needs.policy.result }}',
              Heal:   '${{ needs.heal.result   }}',
              Build:  '${{ needs.build.result  }}',
              Test:   '${{ needs.test.result   }}',
              Deploy: '${{ needs.deploy.result }}',
            };

            const e = r => ({ success:'âœ…', failure:'âŒ', skipped:'â­ï¸', cancelled:'ðŸš«' }[r] ?? 'â¬œ');
            const rows = Object.entries(results)
              .map(([j, r]) => `| ${e(r)} | **${j}** | \`${r}\` |`)
              .join('\n');
            const allOk = Object.values(results)
              .filter(r => r !== 'skipped')
              .every(r => r === 'success');

            const badge = allOk
              ? '![Passed](https://img.shields.io/badge/pipeline-passed-brightgreen)'
              : '![Failed](https://img.shields.io/badge/pipeline-failed-red)';

            const body = [
              botTag,
              `---`,
              `### ${allOk ? 'âœ…' : 'âŒ'} SMSDAO Pipeline Summary â€” \`${phase}\` Â· \`${env_}\` ${badge}`,
              '',
              '| | Phase | Result |',
              '|---|---|---|',
              rows,
              '',
              '| Field | Value |',
              '|---|---|',
              `| Run | ${runUrl} |`,
              `| Timestamp | ${ts} |`,
              `| Platform | [SMSDAO/platform](https://github.com/SMSDAO/platform) |`,
            ].join('\n');

            // Resolve stale bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: prNum, per_page: 100
            });
            const prev = comments.find(c => c.body.includes(botTag));
            if (prev) await github.rest.issues.deleteComment({
              owner: context.repo.owner, repo: context.repo.repo, comment_id: prev.id
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: prNum, body
            });
